# Attack Vector Arising from Naïve Use of the `+layout.server.js` Tree  
*(Issue #6315 – sveltejs/kit)*  

---

## 1. Problem Overview  

SvelteKit’s **layout tree** (`+layout.server.js`) is designed to provide data that is shared by all child routes.  
Because the client‑side router decides which parts of the tree to fetch, a developer can inadvertently place **authorization logic** in a layout load function and assume it will run on every navigation.  

When a user is signed out (e.g., cookie deleted in another tab) and then navigates to a different page within the same layout group, the layout load function is **not re‑executed**.  
The result: the user is shown protected data without being redirected to the sign‑in page.

> **TL;DR** – Authorization placed in `+layout.server.js` can be bypassed by client‑side navigation if the layout load is not forced to run on every request.

---

## 2. Minimal Reproduction

```bash
git clone https://github.com/cdcarson/yellow-submarine.git
cd yellow-submarine
npm i
npm run dev
```

1. Visit `http://127.0.0.1:5173/launch-codes`.  
   *If not signed in, you’ll be redirected to the sign‑in page.*  
2. Navigate through the paginated list.  
3. In the browser console, delete the `signedIn` cookie (simulate sign‑out).  
4. Without refreshing, click to another page in the list.  
   *You’ll see the page instead of being redirected to `/sign-in`.*

The same steps performed on the “fixed” route (`/launch-codes-fixed`) – where the auth check lives in `+page.server.ts` – correctly redirect to `/sign-in`.

---

## 3. Key Code Snippets

### 3.1 Naïve Layout‑Based Auth

```ts
// src/routes/launch-codes/+layout.server.ts
export const load = async (event) => {
  const signedIn = gateAuthenticated(event); // ← auth logic
  return { signedIn };
};
```

### 3.2 Suggested “Always Run” Hook

```ts
// Rich‑Harris proposal
import type { LayoutServerLoad } from '../../../.svelte-kit/types/src/routes/launch-codes/$types';
import type { LaunchCodeLayoutData } from './shared';

export const load: LayoutServerLoad = (event): LaunchCodeLayoutData => {
  event.alwaysRun();          // ← force re‑execution on every navigation
  const signedIn = gateAuthenticated(event);
  return { signedIn };
};
```

### 3.3 Guard Function Alternative

```ts
// Proposed guard pattern
export type LayoutServerGuard = (event: RequestEvent) => MaybePromise<void>;

export const guard: LayoutServerGuard = async (event) => {
  // Perform auth check
  if (!userIsAuthorized(event)) {
    throw error(401, 'Not authorized');
  }
};
```

### 3.4 Hook‑Based Auth (Recommended)

```ts
// src/hooks.server.ts
import { getUserFromCookieOrHeader } from '$lib/auth';

export const handle = async ({ event, resolve }) => {
  const user = await getUserFromCookieOrHeader(event);

  // Protect routes that start with /(protected)
  if (event.route.id?.startsWith('/(protected)') && !user) {
    throw error(401, 'Not authenticated');
  }

  return resolve(event);
};
```

---

## 4. Discussion Highlights

| Contributor | Key Point |
|-------------|-----------|
| **CaptainCodeman** | “For security you need to check auth on *every* request.” |
| **Rich‑Harris** | Introduced `event.alwaysRun()` to force layout load re‑execution. |
| **cdcarson** | Emphasised that forgetting `event.alwaysRun()` is a foot‑gun. |
| **ivanhofer** | Outlined three main issues: missing checks, parallel load execution, and duplicated code. |
| **harunzafer** | Noted that `url.href` trick does not work in newer SvelteKit. |
| **NicoAvanzDev** | Advocated moving all auth logic to `hooks.server.ts`. |
| **coryvirok** | Discussed lack of a client‑side `handle` hook. |

---

## 5. Recommended Solution

1. **Move all authentication/authorization logic to `hooks.server.ts`.**  
   *This guarantees the check runs on every request, regardless of layout or page.*  

2. **Use route groups to declaratively protect sections.**  
   ```ts
   // src/routes/(protected)/+layout.server.ts
   export const load = async (event) => {
     // optional shared data for protected routes
   };
   ```

3. **If you still need layout‑specific guards, use the guard pattern** (see §3.3) **and ensure it is awaited before any child load runs.**

4. **Avoid relying on `event.alwaysRun()` or `url.href` tricks** – they are fragile and may break with future SvelteKit updates.

---

## 6. Quick Reference

| File | Purpose | Example |
|------|---------|---------|
| `+layout.server.ts` | Shared data for child routes | `export const load = async (event) => ({ user: await getUser(event) });` |
| `+page.server.ts` | Page‑specific data | `export const load = async (event) => ({ items: await fetchItems(event) });` |
| `hooks.server.ts` | Global request middleware | `export const handle = async ({ event, resolve }) => { /* auth */ };` |
| `+auth.server.ts` *(proposed)* | Dedicated auth guard (not yet in SvelteKit) | `export const guard = async (event) => { /* auth */ };` |

---

## 7. Take‑away

- **Never rely solely on layout load functions for authentication.**  
- **Centralise auth checks in `hooks.server.ts`** to avoid missing a guard on any route.  
- **Document the pattern** in your project README so new developers understand the security model.

---

*All examples above are taken verbatim from the original issue discussion to preserve context and clarity.*